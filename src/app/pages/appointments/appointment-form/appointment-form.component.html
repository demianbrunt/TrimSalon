<div class="p-4">
  <p-card
    [ngClass]="{ 'mobile-card': isMobile }"
    styleClass="mx-auto max-w-4xl"
  >
    <ng-template pTemplate="title">
      <h2 class="m-0">
        {{ isEditMode ? "Afspraak Bewerken" : "Nieuwe Afspraak" }}
      </h2>
    </ng-template>

    <form [formGroup]="form" class="p-fluid">
      <!-- STAP 1: KLANT & HOND SELECTIE -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-user text-primary"></i>
          Klant & Hond
        </h3>
        <div class="formgrid grid">
          <div class="field col-12 md:col-6">
            <label for="client" class="block mb-2 font-medium"
              >Klant <span class="text-red-500">*</span></label
            >
            <p-select
              id="client"
              [formControl]="client"
              [options]="clients"
              optionLabel="name"
              [filter]="true"
              filterBy="name"
              placeholder="Selecteer een klant"
              [showClear]="true"
              styleClass="w-full"
              appendTo="body"
            />
            @if (!client.value) {
              <small class="text-color-secondary mt-1 block"
                >Kies de klant voor deze afspraak</small
              >
            }
          </div>

          <div class="field col-12 md:col-6">
            <label for="dog" class="block mb-2 font-medium"
              >Hond <span class="text-red-500">*</span></label
            >
            <p-select
              id="dog"
              [formControl]="dog"
              [options]="dogs"
              optionLabel="name"
              [filter]="true"
              filterBy="name"
              placeholder="Selecteer een hond"
              [showClear]="true"
              [disabled]="!client.value"
              styleClass="w-full"
              appendTo="body"
            />
            @if (!client.value) {
              <small class="text-color-secondary mt-1 block"
                >Selecteer eerst een klant</small
              >
            } @else if (dog.value && dog.value.breed) {
              <small class="text-color-secondary mt-1 block">
                <i class="pi pi-info-circle"></i>
                Ras: {{ dog.value.breed.name }} ({{
                  dog.value.breed.size === "small"
                    ? "Klein"
                    : dog.value.breed.size === "medium"
                      ? "Middel"
                      : "Groot"
                }})
              </small>
            }
          </div>
        </div>
      </div>

      <p-divider />

      <!-- STAP 2: WERKZAAMHEDEN -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-wrench text-primary"></i>
          Werkzaamheden
        </h3>
        <div class="formgrid grid">
          <div class="field col-12 md:col-6">
            <label for="packages" class="block mb-2 font-medium"
              >Pakketten</label
            >
            <p-multiSelect
              id="packages"
              [options]="packages"
              [formControl]="packagesControl"
              optionLabel="name"
              placeholder="Selecteer pakketten"
              display="chip"
              [showClear]="true"
              styleClass="w-full"
              appendTo="body"
            />
            <small class="text-color-secondary mt-1 block"
              >Voorgedefinieerde pakketten (optioneel)</small
            >
          </div>

          <div class="field col-12 md:col-6">
            <label for="services" class="block mb-2 font-medium"
              >Extra Services</label
            >
            <p-multiSelect
              id="services"
              [options]="services"
              [formControl]="servicesControl"
              optionLabel="name"
              placeholder="Selecteer extra services"
              display="chip"
              [showClear]="true"
              styleClass="w-full"
              appendTo="body"
            />
            <small class="text-color-secondary mt-1 block"
              >Aanvullende werkzaamheden (optioneel)</small
            >
          </div>
        </div>

        <!-- Geschatte Duur en Prijs Indicator -->
        @if (estimatedDurationMinutes > 0 || priceCalculation) {
          <div class="mt-3 grid">
            @if (estimatedDurationMinutes > 0) {
              <div class="col-12 md:col-6">
                <div class="bg-primary-50 border-round p-3 h-full">
                  <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-clock text-primary text-xl"></i>
                    <div class="font-semibold text-primary">
                      Geschatte duur: {{ formatDuration(estimatedDurationMinutes) }}
                    </div>
                  </div>
                  <small class="text-color-secondary">
                    Gebaseerd op hondengrootte en geselecteerde werkzaamheden
                  </small>
                </div>
              </div>
            }
            @if (priceCalculation && priceCalculation.totalPrice > 0) {
              <div class="col-12 md:col-6">
                <div class="bg-green-50 border-round p-3 h-full">
                  <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-euro text-green-600 text-xl"></i>
                    <div class="font-semibold text-green-600">
                      Geschatte prijs: {{ priceCalculation.totalPrice | currency: 'EUR' }}
                    </div>
                  </div>
                  @if (hourlyRateCalculation && hourlyRateCalculation.effectiveHourlyRate > 0) {
                    <small class="text-color-secondary">
                      Effectief uurtarief: {{ hourlyRateCalculation.effectiveHourlyRate | number: '1.0-0' }} €/uur
                      @if (hourlyRateCalculation.rateComparison >= 95) {
                        <i class="pi pi-check-circle text-green-600 ml-1"></i>
                      } @else if (hourlyRateCalculation.rateComparison >= 80) {
                        <i class="pi pi-exclamation-triangle text-orange-500 ml-1"></i>
                      } @else {
                        <i class="pi pi-times-circle text-red-500 ml-1"></i>
                      }
                      ({{ hourlyRateCalculation.rateComparison | number: '1.0-0' }}% van streefdoel €{{ hourlyRateCalculation.targetRate }})
                    </small>
                  }
                </div>
              </div>
            }
          </div>
        }
        
        <!-- Price Breakdown -->
        @if (priceCalculation && priceCalculation.breakdown.length > 0) {
          <div class="mt-3">
            <div class="text-sm font-semibold mb-2">Prijsopbouw:</div>
            <div class="grid gap-2">
              @for (item of priceCalculation.breakdown; track item.name) {
                <div class="col-12">
                  <div class="flex justify-content-between align-items-center p-2 bg-gray-50 border-round">
                    <span class="text-sm">
                      <i [class]="item.type === 'package' ? 'pi pi-box text-primary' : 'pi pi-wrench text-primary'"></i>
                      {{ item.name }}
                    </span>
                    <span class="font-semibold text-sm">{{ item.price | currency: 'EUR' }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <p-divider />

      <!-- STAP 3: DATUM & TIJD -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-calendar text-primary"></i>
          Planning
        </h3>
        <div class="formgrid grid">
          <div class="field col-12 md:col-4">
            <label for="appointmentDate" class="block mb-2 font-medium"
              >Datum <span class="text-red-500">*</span></label
            >
            <p-datepicker
              id="appointmentDate"
              formControlName="appointmentDate"
              dateFormat="dd-mm-yy"
              [showIcon]="true"
              placeholder="Kies een datum"
              styleClass="w-full"
              appendTo="body"
            />
          </div>

          <div class="field col-12 md:col-4">
            <label for="startTime" class="block mb-2 font-medium"
              >Starttijd <span class="text-red-500">*</span></label
            >
            <p-datepicker
              id="startTime"
              formControlName="startTime"
              [timeOnly]="true"
              hourFormat="24"
              [showIcon]="true"
              placeholder="Kies starttijd"
              styleClass="w-full"
              appendTo="body"
            />
          </div>

          <div class="field col-12 md:col-4">
            <label for="calculatedEndTime" class="block mb-2 font-medium"
              >Verwachte eindtijd</label
            >
            <div
              class="p-inputtext w-full flex align-items-center"
              style="height: 48px"
            >
              @if (calculatedEndTime) {
                <span class="font-semibold text-primary">
                  {{
                    calculatedEndTime
                      | date: "HH:mm"
                  }}
                </span>
              } @else {
                <span class="text-color-secondary">Wordt berekend...</span>
              }
            </div>
            <small class="text-color-secondary mt-1 block"
              >Automatisch berekend op basis van geschatte duur</small
            >
          </div>
        </div>

        @if (isEditMode) {
          <p-divider />
          
          <!-- WERKELIJK UITGEVOERD WERK -->
          <div class="mt-4">
            <h4 class="text-md font-semibold mb-3 flex align-items-center gap-2">
              <i class="pi pi-check-square text-green-600"></i>
              Werkelijk Uitgevoerd Werk (Logboek)
            </h4>
            <div class="formgrid grid">
              <div class="field col-12 md:col-4">
                <label for="actualEndTime" class="block mb-2 font-medium"
                  >Werkelijke eindtijd <span class="text-red-500">*</span></label
                >
                <p-datepicker
                  id="actualEndTime"
                  formControlName="actualEndTime"
                  [showTime]="true"
                  hourFormat="24"
                  dateFormat="dd-mm-yy"
                  [showIcon]="true"
                  placeholder="Werkelijke eindtijd"
                  styleClass="w-full"
                  appendTo="body"
                />
                <small class="text-color-secondary mt-1 block"
                  >Pas aan na voltooiing van de afspraak</small
                >
              </div>
              
              <div class="field col-12 md:col-4">
                <label for="actualPackages" class="block mb-2 font-medium"
                  >Werkelijk uitgevoerde pakketten</label
                >
                <p-multiSelect
                  id="actualPackages"
                  [options]="packages"
                  formControlName="actualPackages"
                  optionLabel="name"
                  placeholder="Selecteer pakketten"
                  display="chip"
                  [showClear]="true"
                  styleClass="w-full"
                  appendTo="body"
                />
                <small class="text-color-secondary mt-1 block"
                  >Wijzig indien afwijkend van geschatte</small
                >
              </div>
              
              <div class="field col-12 md:col-4">
                <label for="actualServices" class="block mb-2 font-medium"
                  >Werkelijk uitgevoerde services</label
                >
                <p-multiSelect
                  id="actualServices"
                  [options]="services"
                  formControlName="actualServices"
                  optionLabel="name"
                  placeholder="Selecteer services"
                  display="chip"
                  [showClear]="true"
                  styleClass="w-full"
                  appendTo="body"
                />
                <small class="text-color-secondary mt-1 block"
                  >Wijzig indien afwijkend van geschatte</small
                >
              </div>
            </div>

            <!-- Actual Pricing Display -->
            @if (actualPriceCalculation && actualHourlyRateCalculation) {
              <div class="mt-3 grid">
                <div class="col-12 md:col-6">
                  <div class="bg-blue-50 border-round p-3 h-full">
                    <div class="flex align-items-center gap-2 mb-2">
                      <i class="pi pi-euro text-blue-600 text-xl"></i>
                      <div class="font-semibold text-blue-600">
                        Werkelijke prijs: {{ actualPriceCalculation.totalPrice | currency: 'EUR' }}
                      </div>
                    </div>
                    <small class="text-color-secondary">
                      Totale duur: {{ formatDuration(actualHourlyRateCalculation.totalMinutes) }}
                    </small>
                  </div>
                </div>
                
                <div class="col-12 md:col-6">
                  <div class="bg-purple-50 border-round p-3 h-full">
                    <div class="flex align-items-center gap-2 mb-2">
                      <i class="pi pi-chart-line text-purple-600 text-xl"></i>
                      <div class="font-semibold text-purple-600">
                        Behaald uurtarief: {{ actualHourlyRateCalculation.effectiveHourlyRate | number: '1.0-0' }} €/uur
                      </div>
                    </div>
                    <small class="text-color-secondary">
                      @if (actualHourlyRateCalculation.rateComparison >= 95) {
                        <i class="pi pi-check-circle text-green-600"></i> Uitstekend!
                      } @else if (actualHourlyRateCalculation.rateComparison >= 80) {
                        <i class="pi pi-exclamation-triangle text-orange-500"></i> Bijna op streefdoel
                      } @else {
                        <i class="pi pi-times-circle text-red-500"></i> Onder streefdoel
                      }
                      ({{ actualHourlyRateCalculation.rateComparison | number: '1.0-0' }}% van €{{ actualHourlyRateCalculation.targetRate }})
                    </small>
                  </div>
                </div>
              </div>
              
              <!-- Comparison -->
              @if (priceCalculation && hourlyRateCalculation) {
                <div class="mt-3">
                  <div class="bg-gray-50 border-round p-3">
                    <div class="font-semibold mb-2 flex align-items-center gap-2">
                      <i class="pi pi-arrows-h text-gray-600"></i>
                      Vergelijking Geschat vs Werkelijk
                    </div>
                    <div class="grid">
                      <div class="col-12 md:col-4">
                        <small class="text-color-secondary">Prijs verschil:</small>
                        <div class="font-semibold" [class.text-green-600]="actualPriceCalculation.totalPrice >= priceCalculation.totalPrice" [class.text-red-500]="actualPriceCalculation.totalPrice < priceCalculation.totalPrice">
                          {{ (actualPriceCalculation.totalPrice - priceCalculation.totalPrice) | currency: 'EUR' }}
                        </div>
                      </div>
                      <div class="col-12 md:col-4">
                        <small class="text-color-secondary">Tijd verschil:</small>
                        <div class="font-semibold" [class.text-green-600]="actualHourlyRateCalculation.totalMinutes <= estimatedDurationMinutes" [class.text-orange-500]="actualHourlyRateCalculation.totalMinutes > estimatedDurationMinutes">
                          {{ (actualHourlyRateCalculation.totalMinutes - estimatedDurationMinutes) > 0 ? '+' : '' }}{{ formatDuration(Math.abs(actualHourlyRateCalculation.totalMinutes - estimatedDurationMinutes)) }}
                        </div>
                      </div>
                      <div class="col-12 md:col-4">
                        <small class="text-color-secondary">Uurtarief verschil:</small>
                        <div class="font-semibold" [class.text-green-600]="actualHourlyRateCalculation.effectiveHourlyRate >= hourlyRateCalculation.effectiveHourlyRate" [class.text-red-500]="actualHourlyRateCalculation.effectiveHourlyRate < hourlyRateCalculation.effectiveHourlyRate">
                          {{ (actualHourlyRateCalculation.effectiveHourlyRate - hourlyRateCalculation.effectiveHourlyRate) > 0 ? '+' : '' }}{{ (actualHourlyRateCalculation.effectiveHourlyRate - hourlyRateCalculation.effectiveHourlyRate) | number: '1.0-0' }} €/uur
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>

      <p-divider />

      <!-- STAP 4: NOTITIES -->
      <div class="mb-3">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-file-edit text-primary"></i>
          Notities
        </h3>
        <div class="field">
          <label for="notes" class="block mb-2 font-medium"
            >Opmerkingen</label
          >
          <textarea
            id="notes"
            pTextarea
            formControlName="notes"
            rows="4"
            placeholder="Voeg hier eventuele opmerkingen of bijzonderheden toe..."
            class="w-full"
          ></textarea>
          <small class="text-color-secondary mt-1 block"
            >Optioneel - bijv. speciale wensen van de klant</small
          >
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-between align-items-center">
        <!-- Samenvatting -->
        @if (client.value && dog.value) {
          <div class="text-sm text-color-secondary">
            <i class="pi pi-check-circle text-green-500"></i>
            {{ client.value.name }} - {{ dog.value.name }}
            @if (estimatedDurationMinutes > 0) {
              <span class="ml-2">
                • {{ formatDuration(estimatedDurationMinutes) }}
              </span>
            }
          </div>
        } @else {
          <div></div>
        }

        <!-- Acties -->
        <div class="flex gap-2">
          <p-button
            label="Annuleren"
            icon="pi pi-times"
            styleClass="p-button-text"
            (click)="cancel()"
            type="button"
          />
          <p-button
            label="Opslaan"
            icon="pi pi-check"
            (click)="save()"
            [disabled]="form.invalid"
            type="button"
          />
        </div>
      </div>
    </ng-template>
  </p-card>
</div>
