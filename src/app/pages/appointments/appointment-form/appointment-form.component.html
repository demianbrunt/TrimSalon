<div class="p-4">
  <p-card
    [ngClass]="{ 'mobile-card': isMobile }"
    styleClass="mx-auto max-w-4xl"
  >
    <ng-template pTemplate="title">
      <h2 class="m-0">
        {{ isEditMode ? "Afspraak Bewerken" : "Nieuwe Afspraak" }}
      </h2>
    </ng-template>

    <form [formGroup]="form" class="p-fluid">
      <!-- STAP 1: KLANT & HOND SELECTIE -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-user text-primary"></i>
          Klant & Hond
        </h3>
        <div class="formgrid grid">
          <div class="field col-12 md:col-6">
            <label for="client" class="block mb-2 font-medium"
              >Klant <span class="text-red-500">*</span></label
            >
            <p-select
              id="client"
              [formControl]="client"
              [options]="clients"
              optionLabel="name"
              [filter]="true"
              filterBy="name"
              placeholder="Selecteer een klant"
              [showClear]="true"
              styleClass="w-full"
              appendTo="body"
            />
            @if (!client.value) {
              <small class="text-color-secondary mt-1 block"
                >Kies de klant voor deze afspraak</small
              >
            }
          </div>

          <div class="field col-12 md:col-6">
            <label for="dog" class="block mb-2 font-medium"
              >Hond <span class="text-red-500">*</span></label
            >
            <p-select
              id="dog"
              [formControl]="dog"
              [options]="dogs"
              optionLabel="name"
              [filter]="true"
              filterBy="name"
              placeholder="Selecteer een hond"
              [showClear]="true"
              [disabled]="!client.value"
              styleClass="w-full"
              appendTo="body"
            />
            @if (!client.value) {
              <small class="text-color-secondary mt-1 block"
                >Selecteer eerst een klant</small
              >
            } @else if (dog.value && dog.value.breed) {
              <small class="text-color-secondary mt-1 block">
                <i class="pi pi-info-circle"></i>
                Ras: {{ dog.value.breed.name }} ({{
                  dog.value.breed.size === "small"
                    ? "Klein"
                    : dog.value.breed.size === "medium"
                      ? "Middel"
                      : "Groot"
                }})
              </small>
            }
          </div>
        </div>
      </div>

      <p-divider />

      <!-- STAP 2: WERKZAAMHEDEN -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-wrench text-primary"></i>
          Werkzaamheden
        </h3>
        <div class="formgrid grid">
          <div class="field col-12 md:col-6">
            <label for="packages" class="block mb-2 font-medium"
              >Pakketten</label
            >
            <p-multiSelect
              id="packages"
              [options]="packages"
              [formControl]="packagesControl"
              optionLabel="name"
              placeholder="Selecteer pakketten"
              display="chip"
              [showClear]="true"
              styleClass="w-full"
              appendTo="body"
            />
            <small class="text-color-secondary mt-1 block"
              >Voorgedefinieerde pakketten (optioneel)</small
            >
          </div>

          <div class="field col-12 md:col-6">
            <label for="services" class="block mb-2 font-medium"
              >Extra Services</label
            >
            <p-multiSelect
              id="services"
              [options]="services"
              [formControl]="servicesControl"
              optionLabel="name"
              placeholder="Selecteer extra services"
              display="chip"
              [showClear]="true"
              styleClass="w-full"
              appendTo="body"
            />
            <small class="text-color-secondary mt-1 block"
              >Aanvullende werkzaamheden (optioneel)</small
            >
          </div>
        </div>

        <!-- Geschatte Duur Indicator -->
        @if (estimatedDurationMinutes > 0) {
          <div
            class="bg-primary-50 border-round p-3 mt-3 flex align-items-center gap-2"
          >
            <i class="pi pi-clock text-primary text-xl"></i>
            <div>
              <div class="font-semibold text-primary">
                Geschatte duur: {{ formatDuration(estimatedDurationMinutes) }}
              </div>
              <small class="text-color-secondary">
                Gebaseerd op hondengrootte en geselecteerde werkzaamheden
              </small>
            </div>
          </div>
        }
      </div>

      <p-divider />

      <!-- STAP 3: DATUM & TIJD -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-calendar text-primary"></i>
          Planning
        </h3>
        <div class="formgrid grid">
          <div class="field col-12 md:col-4">
            <label for="appointmentDate" class="block mb-2 font-medium"
              >Datum <span class="text-red-500">*</span></label
            >
            <p-datepicker
              id="appointmentDate"
              formControlName="appointmentDate"
              dateFormat="dd-mm-yy"
              [showIcon]="true"
              placeholder="Kies een datum"
              styleClass="w-full"
              appendTo="body"
            />
          </div>

          <div class="field col-12 md:col-4">
            <label for="startTime" class="block mb-2 font-medium"
              >Starttijd <span class="text-red-500">*</span></label
            >
            <p-datepicker
              id="startTime"
              formControlName="startTime"
              [timeOnly]="true"
              hourFormat="24"
              [showIcon]="true"
              placeholder="Kies starttijd"
              styleClass="w-full"
              appendTo="body"
            />
          </div>

          <div class="field col-12 md:col-4">
            <label for="calculatedEndTime" class="block mb-2 font-medium"
              >Verwachte eindtijd</label
            >
            <div
              class="p-inputtext w-full flex align-items-center"
              style="height: 48px"
            >
              @if (calculatedEndTime) {
                <span class="font-semibold text-primary">
                  {{
                    calculatedEndTime
                      | date: "HH:mm"
                  }}
                </span>
              } @else {
                <span class="text-color-secondary">Wordt berekend...</span>
              }
            </div>
            <small class="text-color-secondary mt-1 block"
              >Automatisch berekend op basis van geschatte duur</small
            >
          </div>
        </div>

        @if (isEditMode) {
          <div class="formgrid grid mt-3">
            <div class="field col-12 md:col-6">
              <label for="endTime" class="block mb-2 font-medium"
                >Werkelijke eindtijd <span class="text-red-500">*</span></label
              >
              <p-datepicker
                id="endTime"
                formControlName="endTime"
                [showTime]="true"
                hourFormat="24"
                dateFormat="dd-mm-yy"
                [showIcon]="true"
                placeholder="Werkelijke eindtijd"
                styleClass="w-full"
                appendTo="body"
              />
              <small class="text-color-secondary mt-1 block"
                >Pas aan indien nodig na voltooiing</small
              >
            </div>
          </div>
        }
      </div>

      <p-divider />

      <!-- STAP 4: NOTITIES -->
      <div class="mb-3">
        <h3 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-file-edit text-primary"></i>
          Notities
        </h3>
        <div class="field">
          <label for="notes" class="block mb-2 font-medium"
            >Opmerkingen</label
          >
          <textarea
            id="notes"
            pTextarea
            formControlName="notes"
            rows="4"
            placeholder="Voeg hier eventuele opmerkingen of bijzonderheden toe..."
            class="w-full"
          ></textarea>
          <small class="text-color-secondary mt-1 block"
            >Optioneel - bijv. speciale wensen van de klant</small
          >
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-between align-items-center">
        <!-- Samenvatting -->
        @if (client.value && dog.value) {
          <div class="text-sm text-color-secondary">
            <i class="pi pi-check-circle text-green-500"></i>
            {{ client.value.name }} - {{ dog.value.name }}
            @if (estimatedDurationMinutes > 0) {
              <span class="ml-2">
                â€¢ {{ formatDuration(estimatedDurationMinutes) }}
              </span>
            }
          </div>
        } @else {
          <div></div>
        }

        <!-- Acties -->
        <div class="flex gap-2">
          <p-button
            label="Annuleren"
            icon="pi pi-times"
            styleClass="p-button-text"
            (click)="cancel()"
            type="button"
          />
          <p-button
            label="Opslaan"
            icon="pi pi-check"
            (click)="save()"
            [disabled]="form.invalid"
            type="button"
          />
        </div>
      </div>
    </ng-template>
  </p-card>
</div>
