<div
  class="appointments-container"
  appPullToRefresh
  #ptr="appPullToRefresh"
  (refresh)="onPullToRefresh($event)"
>
  <div class="ptr-indicator" role="status" aria-live="polite">
    <div class="ptr-indicator__bubble" aria-hidden="true">
      <i
        [class]="
          ptr.state === 'refreshing'
            ? 'pi pi-refresh pi-spin'
            : ptr.state === 'ready'
              ? 'pi pi-arrow-up'
              : 'pi pi-arrow-down'
        "
      ></i>
    </div>
    <span class="sr-only">
      @switch (ptr.state) {
        @case ("refreshing") {
          Vernieuwenâ€¦
        }
        @case ("ready") {
          Loslaten om te vernieuwen
        }
        @default {
          Trek omlaag om te vernieuwen
        }
      }
    </span>
  </div>
  <div
    class="view-toggle-container"
    [class.view-toggle-container--calendar]="viewMode === 'calendar'"
  >
    <div class="gradient-toggle">
      @for (option of viewModeOptions; track option.value) {
        <button
          class="gradient-option"
          [class.active]="viewMode === option.value"
          (click)="setViewMode(option.value)"
        >
          <i [class]="option.icon"></i>
          <span class="hidden md:inline ml-2">{{ option.label }}</span>
        </button>
      }
    </div>
  </div>

  @if (viewMode === "calendar") {
    <app-custom-calendar
      [appointments]="appointments"
      (appointmentClick)="onCalendarAppointmentClick($event)"
      (dateClick)="onCalendarDateClick($event)"
    >
      <p-button
        header-actions
        icon="pi pi-cog"
        (onClick)="openSyncSettings()"
        [text]="true"
        [rounded]="true"
        pTooltip="Google Agenda synchronisatie"
        size="small"
      ></p-button>
    </app-custom-calendar>
  } @else {
    @if (isMobile) {
      <div
        appSwipe
        (swipeLeft)="onListSwipe('left')"
        (swipeRight)="onListSwipe('right')"
      >
        <p-dataView
          #dv
          styleClass="mobile-card-list mobile-card-list--fixed-header"
          [value]="visibleAppointments"
          [paginator]="true"
          [rows]="mobileRows"
          [first]="(page - 1) * mobileRows"
          (onPage)="onMobilePage($event)"
          [sortField]="sortField"
          [sortOrder]="sortOrder"
          [filterBy]="'client.name,dog.name'"
        >
          <ng-template #header>
            <app-table-header
              placeholder="Zoek afspraak"
              [table]="dv"
              [query]="searchQuery"
              [showAdd]="false"
              (queryChange)="onSearchQueryChange($event)"
            >
              <div header-actions class="flex gap-2 align-items-center">
                <p-button
                  [label]="isMobile ? 'Filters' : ''"
                  icon="pi pi-filter"
                  [text]="true"
                  [rounded]="!isMobile"
                  size="small"
                  (click)="mobileFiltersOpen = !mobileFiltersOpen"
                  [attr.aria-expanded]="mobileFiltersOpen"
                  aria-controls="appointmentsMobileFilters"
                  ariaLabel="Filters"
                  [pTooltip]="!isMobile ? 'Filters' : ''"
                ></p-button>

                <p-button
                  label="Reset"
                  icon="pi pi-filter-slash"
                  [text]="true"
                  (click)="resetFilters()"
                  size="small"
                  ariaLabel="Reset filters"
                ></p-button>
              </div>
            </app-table-header>

            <div
              class="mobile-filters-panel"
              id="appointmentsMobileFilters"
              [class.is-open]="mobileFiltersOpen"
              [attr.aria-hidden]="!mobileFiltersOpen"
            >
              <div class="mobile-filters">
                <div
                  class="flex flex-row flex-wrap justify-content-between align-items-center gap-2"
                >
                  <p-selectButton
                    [options]="statusFilterOptions"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="statusFilter"
                    (ngModelChange)="setStatusFilter($event)"
                    [allowEmpty]="false"
                    ariaLabel="Filter afspraken"
                    styleClass="w-auto"
                  ></p-selectButton>

                  <div class="flex gap-2">
                    <p-button
                      label="Actief"
                      [text]="showArchived"
                      [outlined]="showArchived"
                      [attr.aria-pressed]="!showArchived"
                      (click)="setShowArchived(false)"
                      size="small"
                    ></p-button>
                    <p-button
                      label="Archief"
                      [text]="!showArchived"
                      [outlined]="!showArchived"
                      [attr.aria-pressed]="showArchived"
                      (click)="setShowArchived(true)"
                      size="small"
                    ></p-button>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>

          <ng-template #emptymessage></ng-template>

          <ng-template #list let-items>
            @for (appointment of items; track appointment.id) {
              <div class="col-12 md:col-6 lg:col-4 p-2">
                <p-card
                  (click)="showAppointmentForm(appointment)"
                  [styleClass]="
                    appointment.completed
                      ? 'mobile-card completed-appointment h-full'
                      : 'mobile-card h-full'
                  "
                >
                  <ng-template pTemplate="header">
                    <div class="p-3">
                      <div
                        class="flex justify-content-between align-items-start"
                      >
                        <div class="font-bold text-lg">
                          {{ appointment.client.name }} -
                          {{ appointment.dog.name }}
                          @if (appointment.dog.isInactive) {
                            <p-tag
                              value="Niet actief"
                              severity="warn"
                              styleClass="ml-2"
                            ></p-tag>
                          }
                          @if (appointment.dog.isAggressive) {
                            <i
                              class="pi pi-exclamation-triangle text-red-600 ml-2"
                              pTooltip="Agressief dier"
                            ></i>
                          }
                        </div>
                        @if (appointment.completed) {
                          <p-tag
                            value="Afgerond"
                            severity="success"
                            [rounded]="true"
                          ></p-tag>
                        }
                      </div>
                    </div>
                  </ng-template>

                  <div class="text-color-secondary mb-2">
                    <i class="pi pi-calendar mr-2"></i>
                    {{ appointment.startTime | date: "EEEE d MMMM yyyy" }}
                  </div>
                  <div class="text-color-secondary mb-3">
                    <i class="pi pi-clock mr-2"></i>
                    {{ appointment.startTime | date: "HH:mm" }} -
                    {{ appointment.endTime | date: "HH:mm" }}
                  </div>
                  @if (
                    appointment.completed &&
                    appointment.actualPrice !== null &&
                    appointment.actualPrice !== undefined
                  ) {
                    <div class="text-sm text-primary mb-2">
                      <i class="pi pi-euro mr-2"></i>
                      Werkelijke prijs:
                      {{ appointment.actualPrice | currency: "EUR" }}
                    </div>
                  }
                  <div>
                    <div class="flex flex-wrap gap-1">
                      @for (service of appointment.services; track service.id) {
                        <p-tag [value]="service.name" severity="info"></p-tag>
                      }
                      @for (pkg of appointment.packages; track pkg.id) {
                        <p-tag [value]="pkg.name" severity="success"></p-tag>
                      }
                    </div>
                  </div>

                  <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                      @if (appointment.deletedAt) {
                        <p-button
                          icon="pi pi-undo"
                          [text]="true"
                          [rounded]="true"
                          (click)="
                            $event.stopPropagation();
                            restoreAppointment(appointment)
                          "
                          pTooltip="Herstellen"
                        ></p-button>
                      } @else {
                        @if (!appointment.completed) {
                          <p-button
                            icon="pi pi-check"
                            severity="success"
                            [text]="true"
                            [rounded]="true"
                            (click)="
                              $event.stopPropagation();
                              completeAppointment(appointment)
                            "
                            pTooltip="Afronden"
                          ></p-button>
                        }
                        <p-button
                          icon="pi pi-pencil"
                          [text]="true"
                          [rounded]="true"
                          (click)="
                            $event.stopPropagation();
                            editAppointment(appointment)
                          "
                          pTooltip="Bewerken"
                        ></p-button>
                        <p-button
                          icon="pi pi-inbox"
                          severity="danger"
                          [text]="true"
                          [rounded]="true"
                          (click)="
                            $event.stopPropagation();
                            deleteAppointment(appointment)
                          "
                          pTooltip="Archiveren"
                        ></p-button>
                      }
                    </div>
                  </ng-template>
                </p-card>
              </div>
            } @empty {
              <div class="text-center p-4">Geen afspraken gevonden.</div>
            }
          </ng-template>
        </p-dataView>
      </div>

      <div class="appointments-fab-container">
        <p-button
          icon="pi pi-plus"
          [rounded]="true"
          (onClick)="showAppointmentForm()"
          pTooltip="Nieuwe afspraak"
          tooltipPosition="left"
          size="large"
          ariaLabel="Nieuwe afspraak"
        ></p-button>
      </div>
    } @else {
      <div class="p-4">
        <p-card>
          <p-table
            #dt
            [value]="visibleAppointments"
            [paginator]="true"
            [rows]="desktopRows"
            [first]="(page - 1) * desktopRows"
            (onPage)="onDesktopPage($event)"
            [sortField]="sortField"
            [sortOrder]="sortOrder"
            [filterDelay]="0"
            [globalFilterFields]="['client.name', 'dog.name']"
            [tableStyle]="{ 'min-width': '75rem' }"
          >
            <ng-template pTemplate="caption">
              <div class="flex flex-column gap-2">
                <app-table-header
                  placeholder="Zoek afspraak"
                  [table]="dt"
                  [query]="searchQuery"
                  (queryChange)="onSearchQueryChange($event)"
                  (addClick)="showAppointmentForm()"
                >
                  <div
                    header-actions
                    class="flex flex-wrap gap-2 align-items-center"
                  >
                    <p-button
                      label="Filters"
                      icon="pi pi-filter"
                      [text]="true"
                      size="small"
                      (click)="desktopFiltersOpen = !desktopFiltersOpen"
                      [attr.aria-expanded]="desktopFiltersOpen"
                      aria-controls="appointmentsDesktopFilters"
                    ></p-button>

                    <p-button
                      label="Reset"
                      icon="pi pi-filter-slash"
                      [text]="true"
                      (click)="resetFilters()"
                      size="small"
                      ariaLabel="Reset filters"
                    ></p-button>
                  </div>
                </app-table-header>

                <div
                  id="appointmentsDesktopFilters"
                  class="appointments-desktop-filters"
                  [hidden]="!desktopFiltersOpen"
                >
                  <div class="appointments-desktop-filters__inner">
                    <p-selectButton
                      [options]="statusFilterOptions"
                      optionLabel="label"
                      optionValue="value"
                      [ngModel]="statusFilter"
                      (ngModelChange)="setStatusFilter($event)"
                      [allowEmpty]="false"
                      ariaLabel="Filter afspraken"
                    ></p-selectButton>

                    <div class="flex gap-2 mt-2">
                      <p-button
                        label="Actief"
                        [text]="showArchived"
                        [outlined]="showArchived"
                        [attr.aria-pressed]="!showArchived"
                        (click)="setShowArchived(false)"
                        size="small"
                      ></p-button>
                      <p-button
                        label="Archief"
                        [text]="!showArchived"
                        [outlined]="!showArchived"
                        [attr.aria-pressed]="showArchived"
                        (click)="setShowArchived(true)"
                        size="small"
                      ></p-button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="client.name">
                  Klant <p-sortIcon field="client.name"></p-sortIcon>
                </th>
                <th pSortableColumn="dog.name">
                  Hond <p-sortIcon field="dog.name"></p-sortIcon>
                </th>
                <th>Werkzaamheden & Pakketten</th>
                <th pSortableColumn="startTime">
                  Starttijd <p-sortIcon field="startTime"></p-sortIcon>
                </th>
                <th pSortableColumn="endTime">
                  Eindtijd <p-sortIcon field="endTime"></p-sortIcon>
                </th>
                <th style="width: 10rem"></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-appointment>
              <tr
                (click)="showAppointmentForm(appointment)"
                style="cursor: pointer"
              >
                <td>{{ appointment.client.name }}</td>
                <td>
                  {{ appointment.dog.name }}
                  @if (appointment.dog.isInactive) {
                    <p-tag
                      value="Niet actief"
                      severity="warn"
                      styleClass="ml-2"
                    ></p-tag>
                  }
                  @if (appointment.dog.isAggressive) {
                    <i
                      class="pi pi-exclamation-triangle text-red-600 ml-2"
                      pTooltip="Agressief dier"
                    ></i>
                  }
                  @if (appointment.completed) {
                    <p-tag
                      value="Afgerond"
                      severity="success"
                      [rounded]="true"
                      styleClass="ml-2"
                    ></p-tag>
                  }
                </td>
                <td>
                  <div class="flex flex-wrap gap-1">
                    @for (service of appointment.services; track service.id) {
                      <p-tag [value]="service.name" severity="info"></p-tag>
                    }
                    @for (pkg of appointment.packages; track pkg.id) {
                      <p-tag [value]="pkg.name" severity="success"></p-tag>
                    }
                  </div>
                </td>
                <td>
                  <i class="pi pi-calendar mr-2 text-secondary"></i>
                  {{ appointment.startTime | date: "dd-MM-yyyy" }}
                  <br />
                  <i class="pi pi-clock mr-2 text-secondary"></i>
                  {{ appointment.startTime | date: "HH:mm" }}
                </td>
                <td>
                  <i class="pi pi-calendar mr-2 text-secondary"></i>
                  {{ appointment.endTime | date: "dd-MM-yyyy" }}
                  <br />
                  <i class="pi pi-clock mr-2 text-secondary"></i>
                  {{ appointment.endTime | date: "HH:mm" }}
                </td>
                <td>
                  <div class="flex justify-content-end gap-2">
                    @if (appointment.deletedAt) {
                      <p-button
                        icon="pi pi-undo"
                        styleClass="p-button-text p-button-rounded"
                        (click)="
                          $event.stopPropagation();
                          restoreAppointment(appointment)
                        "
                        pTooltip="Herstellen"
                      ></p-button>
                    } @else {
                      @if (!appointment.completed) {
                        <p-button
                          icon="pi pi-check"
                          severity="success"
                          styleClass="p-button-text p-button-rounded"
                          (click)="
                            $event.stopPropagation();
                            completeAppointment(appointment)
                          "
                          pTooltip="Afronden"
                        ></p-button>
                      }
                      <p-button
                        icon="pi pi-pencil"
                        styleClass="p-button-text p-button-rounded"
                        (click)="
                          $event.stopPropagation(); editAppointment(appointment)
                        "
                        pTooltip="Bewerken"
                      ></p-button>
                      <p-button
                        icon="pi pi-inbox"
                        styleClass="p-button-text p-button-rounded p-button-danger"
                        (click)="
                          $event.stopPropagation();
                          deleteAppointment(appointment)
                        "
                        pTooltip="Archiveren"
                      ></p-button>
                    }
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="6" class="text-center">
                  Geen afspraken gevonden.
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>
    }
  }
</div>
