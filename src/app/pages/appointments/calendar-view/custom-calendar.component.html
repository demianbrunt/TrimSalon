<div
  class="calendar-wrapper"
  appSwipe=""
  (swipeLeft)="handleSwipe('left')"
  (swipeRight)="handleSwipe('right')"
  (touchstart)="$event.stopPropagation()"
  (touchmove)="$event.stopPropagation()"
  (touchend)="$event.stopPropagation()"
>
  <div
    class="swipe-indicator"
    [class.left]="swipeIndicator() === 'left'"
    [class.right]="swipeIndicator() === 'right'"
    [class.show]="swipeIndicator() !== null"
    aria-hidden="true"
  >
    <i
      class="pi"
      [class.pi-arrow-left]="swipeIndicator() === 'right'"
      [class.pi-arrow-right]="swipeIndicator() === 'left'"
      aria-hidden="true"
    ></i>
    <span class="swipe-label">{{ swipeIndicatorLabel() }}</span>
  </div>

  <p-card>
    <!-- Header - Optimized for Mobile -->
    <div class="calendar-header" #calendarHeader>
      <div class="calendar-date">
        <p-button
          icon="pi pi-chevron-left"
          (onClick)="previousPeriod()"
          ariaLabel="Vorige periode"
          pTooltip="Vorige"
          [rounded]="true"
          [text]="true"
          size="small"
        />

        <div class="date-display">
          <div class="date-main">
            <span class="date-main__text">{{ currentPeriodMainTitle() }}</span>
            @if (viewMode() === "day" && isCurrentPeriodToday()) {
              <p-badge value="Vandaag" severity="success" styleClass="ml-2" />
            }
          </div>
          <div class="date-sub">{{ currentPeriodSubTitle() }}</div>
        </div>

        <p-button
          icon="pi pi-chevron-right"
          (onClick)="nextPeriod()"
          ariaLabel="Volgende periode"
          pTooltip="Volgende"
          [rounded]="true"
          [text]="true"
          size="small"
        />
      </div>

      <div class="calendar-actions flex align-items-center gap-2">
        <ng-content select="[header-actions]"></ng-content>

        <p-button
          icon="pi pi-calendar"
          (onClick)="goToToday()"
          ariaLabel="Ga naar vandaag"
          pTooltip="Ga naar vandaag"
          [rounded]="true"
          [text]="true"
          size="small"
        />
      </div>
    </div>

    <div class="calendar-mode-bar" aria-label="Kalenderweergave">
      <div
        class="calendar-mode-toggle"
        role="group"
        aria-label="Dag, week of maand"
      >
        @for (option of viewModeOptions; track option.value) {
          <button
            type="button"
            class="calendar-mode-option"
            [class.active]="viewMode() === option.value"
            (click)="setViewMode(option.value)"
            [attr.aria-pressed]="viewMode() === option.value"
          >
            <i [class]="option.icon" aria-hidden="true"></i>
            <span class="hidden md:inline ml-2">{{ option.label }}</span>
          </button>
        }
      </div>
    </div>

    <div
      class="calendar-scroll"
      [class.calendar-scroll--outer-scroll]="viewMode() === 'month'"
    >
      <!-- Week View -->
      @if (viewMode() === "week") {
        <p-table
          [value]="timeSlots"
          [scrollable]="true"
          scrollHeight="flex"
          #calendarTable
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="time-col">Tijd</th>
              @for (day of weekDays(); track day.date.getTime()) {
                <th [class.is-today]="day.isToday" class="text-center p-2">
                  <div class="text-sm text-color-secondary mb-1">
                    {{ dayNames[$index] }}
                  </div>
                  <div
                    class="inline-flex align-items-center justify-content-center border-circle text-sm md:text-base font-semibold"
                    [ngClass]="{
                      'w-2rem h-2rem md:w-2rem md:h-2rem': true,
                      'bg-primary text-primary-contrast': day.isToday,
                      'text-color': !day.isToday,
                    }"
                  >
                    {{ day.dayNumber }}
                  </div>
                </th>
              }
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-slot>
            <tr [class.current-time-row]="isCurrentSlot(slot.slotIndex)">
              <td class="time-col">{{ slot.label }}</td>
              @for (day of weekDays(); track day.date.getTime()) {
                @let spanning =
                  getSpanningAppointmentForCell(day.date, slot.slotIndex);
                @if (spanning) {
                  <td
                    class="day-cell day-cell--spanning p-1 relative"
                    [class.is-today]="day.isToday"
                    (click)="onCellClick(day.date, slot)"
                    tabindex="0"
                    role="button"
                    [attr.rowspan]="spanning.rowSpan"
                  >
                    <!-- Current Time Line -->
                    @if (
                      day.isToday &&
                      isCurrentTimeWithinSpan(slot.slotIndex, spanning.rowSpan)
                    ) {
                      <div
                        class="current-time-line"
                        [style.top.%]="
                          getCurrentTimeOffsetPercentageWithinSpan(
                            slot.slotIndex,
                            spanning.rowSpan
                          )
                        "
                      ></div>
                    }

                    <div
                      class="apt-card apt-card--positioned p-1 md:p-2 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                      [class.border-green-500]="spanning.appointment.completed"
                      [class.surface-green-50]="spanning.appointment.completed"
                      [style.top.%]="
                        getAppointmentTopPctInSpan(
                          spanning.appointment,
                          slot.slotIndex,
                          spanning.rowSpan
                        )
                      "
                      [style.height.%]="
                        getAppointmentHeightPctInSpan(
                          spanning.appointment,
                          slot.slotIndex,
                          spanning.rowSpan
                        )
                      "
                      (click)="onAppointmentClick($event, spanning.appointment)"
                      (contextmenu)="
                        onAppointmentContextMenu($event, spanning.appointment)
                      "
                      (pointerdown)="
                        onAppointmentPointerDown($event, spanning.appointment)
                      "
                      (pointermove)="onAppointmentPointerMove($event)"
                      (pointerup)="onAppointmentPointerUp()"
                      (pointercancel)="onAppointmentPointerCancel()"
                      (pointerleave)="onAppointmentPointerCancel()"
                      tabindex="0"
                      role="button"
                      [pTooltip]="
                        spanning.appointment.client.name +
                        ' - ' +
                        spanning.appointment.dog.name
                      "
                    >
                      <div class="font-semibold text-xs md:text-sm">
                        {{ spanning.appointment.client.name }}
                      </div>
                      <div class="text-xs flex align-items-center gap-1">
                        <span>{{ spanning.appointment.dog.name }}</span>
                        @if (spanning.appointment.dog.isAggressive) {
                          <i
                            class="pi pi-exclamation-triangle text-red-600 font-bold mr-1"
                            pTooltip="LET OP: AGRESSIEF"
                          ></i>
                        }
                      </div>
                      <div class="apt-meta text-2xs md:text-xs">
                        <p-tag
                          (contextmenu)="
                            onAppointmentContextMenu(
                              $event,
                              spanning.appointment
                            )
                          "
                          (pointerdown)="
                            onAppointmentPointerDown(
                              $event,
                              spanning.appointment
                            )
                          "
                          (pointermove)="onAppointmentPointerMove($event)"
                          (pointerup)="onAppointmentPointerUp()"
                          (pointercancel)="onAppointmentPointerCancel()"
                          (pointerleave)="onAppointmentPointerCancel()"
                          severity="info"
                          styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                          [value]="getBreedLabel(spanning.appointment)"
                        ></p-tag>
                        @let gender = getGenderLabel(spanning.appointment);
                        @if (gender) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                          >
                            <i [class]="gender.icon" aria-hidden="true"></i>
                            <span>{{ gender.text }}</span>
                          </p-tag>
                        }
                        @let ageLabel = getAgeLabel(spanning.appointment);
                        @if (ageLabel) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                            [value]="ageLabel"
                          ></p-tag>
                        }
                        @let svcNames = getServiceNames(spanning.appointment);
                        @if (svcNames) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                            [value]="svcNames"
                          ></p-tag>
                        }
                        @let pkgNames = getPackageNames(spanning.appointment);
                        @if (pkgNames) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                            [value]="pkgNames"
                          ></p-tag>
                        }
                        @if (hasNotes(spanning.appointment)) {
                          <p-tag
                            severity="warn"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                          >
                            <i class="pi pi-pencil" aria-hidden="true"></i>
                            <span>Notities</span>
                          </p-tag>
                        }
                      </div>
                      <div class="text-xs mt-1 hidden md:block">
                        {{ spanning.appointment.startTime | date: "HH:mm" }} -
                        {{ spanning.appointment.endTime | date: "HH:mm" }}
                      </div>
                    </div>
                  </td>
                } @else if (
                  isSlotCoveredBySpanningAppointment(day.date, slot.slotIndex)
                ) {
                  <!-- Covered by rowspan above -->
                } @else {
                  <td
                    class="day-cell p-1 relative"
                    [class.is-today]="day.isToday"
                    (click)="onCellClick(day.date, slot)"
                    tabindex="0"
                    role="button"
                  >
                    <!-- Current Time Line -->
                    @if (day.isToday && isCurrentSlot(slot.slotIndex)) {
                      <div
                        class="current-time-line"
                        [style.top.%]="getCurrentSlotMinutePercentage()"
                      ></div>
                    }

                    @let slotApts =
                      getAppointmentsForDaySlot(day.date, slot.slotIndex);

                    @if (slotApts.length === 1) {
                      @let apt = slotApts[0];
                      <div
                        class="apt-card apt-card--positioned p-1 md:p-2 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                        [class.border-green-500]="apt.completed"
                        [class.surface-green-50]="apt.completed"
                        [style.top.%]="getAppointmentTopPctInHour(apt)"
                        [style.height.%]="getAppointmentHeightPctInHour(apt)"
                        (click)="onAppointmentClick($event, apt)"
                        (contextmenu)="onAppointmentContextMenu($event, apt)"
                        (pointerdown)="onAppointmentPointerDown($event, apt)"
                        (pointermove)="onAppointmentPointerMove($event)"
                        (pointerup)="onAppointmentPointerUp()"
                        (pointercancel)="onAppointmentPointerCancel()"
                        (pointerleave)="onAppointmentPointerCancel()"
                        tabindex="0"
                        role="button"
                        [pTooltip]="apt.client.name + ' - ' + apt.dog.name"
                      >
                        <div class="font-semibold text-xs md:text-sm">
                          {{ apt.client.name }}
                        </div>
                        <div class="text-xs flex align-items-center gap-1">
                          <span>{{ apt.dog.name }}</span>
                          @if (apt.dog.isAggressive) {
                            <i
                              class="pi pi-exclamation-triangle text-red-600 font-bold mr-1"
                              pTooltip="LET OP: AGRESSIEF"
                            ></i>
                          }
                        </div>
                        <div class="text-xs mt-1 hidden md:block">
                          {{ apt.startTime | date: "HH:mm" }} -
                          {{ apt.endTime | date: "HH:mm" }}
                        </div>
                      </div>
                    } @else {
                      @for (apt of slotApts; track apt.id) {
                        <div
                          class="apt-card p-1 md:p-2 mb-1 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                          [class.border-green-500]="apt.completed"
                          [class.surface-green-50]="apt.completed"
                          (click)="onAppointmentClick($event, apt)"
                          (contextmenu)="onAppointmentContextMenu($event, apt)"
                          (pointerdown)="onAppointmentPointerDown($event, apt)"
                          (pointermove)="onAppointmentPointerMove($event)"
                          (pointerup)="onAppointmentPointerUp()"
                          (pointercancel)="onAppointmentPointerCancel()"
                          (pointerleave)="onAppointmentPointerCancel()"
                          tabindex="0"
                          role="button"
                          [pTooltip]="apt.client.name + ' - ' + apt.dog.name"
                        >
                          <div class="font-semibold text-xs md:text-sm">
                            {{ apt.client.name }}
                          </div>
                          <div class="text-xs flex align-items-center gap-1">
                            <span>{{ apt.dog.name }}</span>
                            @if (apt.dog.isAggressive) {
                              <i
                                class="pi pi-exclamation-triangle text-red-600 font-bold mr-1"
                                pTooltip="LET OP: AGRESSIEF"
                              ></i>
                            }
                          </div>
                          <div class="apt-meta text-2xs md:text-xs">
                            <p-tag
                              (contextmenu)="
                                onAppointmentContextMenu($event, apt)
                              "
                              (pointerdown)="
                                onAppointmentPointerDown($event, apt)
                              "
                              (pointermove)="onAppointmentPointerMove($event)"
                              (pointerup)="onAppointmentPointerUp()"
                              (pointercancel)="onAppointmentPointerCancel()"
                              (pointerleave)="onAppointmentPointerCancel()"
                              severity="info"
                              styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                              [value]="getBreedLabel(apt)"
                            ></p-tag>
                            @let gender = getGenderLabel(apt);
                            @if (gender) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                              >
                                <i [class]="gender.icon" aria-hidden="true"></i>
                                <span>{{ gender.text }}</span>
                              </p-tag>
                            }
                            @let ageLabel = getAgeLabel(apt);
                            @if (ageLabel) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                                [value]="ageLabel"
                              ></p-tag>
                            }
                            @let svcNames = getServiceNames(apt);
                            @if (svcNames) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                                [value]="svcNames"
                              ></p-tag>
                            }
                            @let pkgNames = getPackageNames(apt);
                            @if (pkgNames) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                                [value]="pkgNames"
                              ></p-tag>
                            }
                            @if (hasNotes(apt)) {
                              <p-tag
                                severity="warn"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                              >
                                <i class="pi pi-pencil" aria-hidden="true"></i>
                                <span>Notities</span>
                              </p-tag>
                            }
                          </div>
                          <div class="text-xs mt-1 hidden md:block">
                            {{ apt.startTime | date: "HH:mm" }} -
                            {{ apt.endTime | date: "HH:mm" }}
                          </div>
                        </div>
                      }
                    }
                  </td>
                }
              }
            </tr>
          </ng-template>
        </p-table>
      }

      <!-- Day View -->
      @if (viewMode() === "day") {
        <p-table
          class="day-view-table"
          [value]="timeSlots"
          [scrollable]="true"
          scrollHeight="flex"
          #calendarTable
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="time-col">Tijd</th>
              <th class="p-2">
                <!-- Datum staat al in de header boven, niet meer nodig in tabel -->
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-slot>
            <tr [class.current-time-row]="isCurrentSlot(slot.slotIndex)">
              <td class="time-col">{{ slot.label }}</td>
              @let spanning =
                getSpanningAppointmentForCell(selectedDate(), slot.slotIndex);

              @if (spanning) {
                <td
                  class="day-cell day-cell--spanning p-1 relative"
                  [class.is-today]="isToday(selectedDate())"
                  (click)="onCellClick(selectedDate(), slot)"
                  tabindex="0"
                  role="button"
                  [attr.rowspan]="spanning.rowSpan"
                >
                  <!-- Current Time Line -->
                  @if (
                    isToday(selectedDate()) &&
                    isCurrentTimeWithinSpan(slot.slotIndex, spanning.rowSpan)
                  ) {
                    <div
                      class="current-time-line"
                      [style.top.%]="
                        getCurrentTimeOffsetPercentageWithinSpan(
                          slot.slotIndex,
                          spanning.rowSpan
                        )
                      "
                    ></div>
                  }

                  <div class="flex flex-column md:flex-row gap-1 md:gap-2">
                    <div
                      class="flex-1 apt-card--positioned p-1 md:p-2 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                      [class.border-green-500]="spanning.appointment.completed"
                      [class.surface-green-50]="spanning.appointment.completed"
                      [style.top.%]="
                        getAppointmentTopPctInSpan(
                          spanning.appointment,
                          slot.slotIndex,
                          spanning.rowSpan
                        )
                      "
                      [style.height.%]="
                        getAppointmentHeightPctInSpan(
                          spanning.appointment,
                          slot.slotIndex,
                          spanning.rowSpan
                        )
                      "
                      (click)="onAppointmentClick($event, spanning.appointment)"
                      tabindex="0"
                      role="button"
                    >
                      <div
                        class="flex justify-content-between align-items-start"
                      >
                        <div class="flex-1">
                          <div class="font-semibold text-xs md:text-sm">
                            {{ spanning.appointment.client.name }}
                          </div>
                          <div class="text-xs flex align-items-center gap-1">
                            <span>{{ spanning.appointment.dog.name }}</span>
                            @if (spanning.appointment.dog.isAggressive) {
                              <i
                                class="pi pi-exclamation-triangle text-red-600 font-bold mr-1"
                                pTooltip="LET OP: AGRESSIEF"
                              ></i>
                            }
                          </div>
                          <div class="text-xs mt-1">
                            {{ spanning.appointment.startTime | date: "HH:mm" }}
                            -
                            {{ spanning.appointment.endTime | date: "HH:mm" }}
                          </div>
                        </div>
                      </div>
                      <div class="apt-meta text-2xs md:text-xs mt-2">
                        <p-tag
                          severity="info"
                          styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                          [value]="getBreedLabel(spanning.appointment)"
                        ></p-tag>
                        @let gender = getGenderLabel(spanning.appointment);
                        @if (gender) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                          >
                            <i [class]="gender.icon" aria-hidden="true"></i>
                            <span>{{ gender.text }}</span>
                          </p-tag>
                        }
                        @let ageLabel = getAgeLabel(spanning.appointment);
                        @if (ageLabel) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                            [value]="ageLabel"
                          ></p-tag>
                        }
                        @let svcNames = getServiceNames(spanning.appointment);
                        @if (svcNames) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                            [value]="svcNames"
                          ></p-tag>
                        }
                        @let pkgNames = getPackageNames(spanning.appointment);
                        @if (pkgNames) {
                          <p-tag
                            severity="secondary"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                            [value]="pkgNames"
                          ></p-tag>
                        }
                        @if (hasNotes(spanning.appointment)) {
                          <p-tag
                            severity="warn"
                            styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                          >
                            <i class="pi pi-pencil" aria-hidden="true"></i>
                            <span>Notities</span>
                          </p-tag>
                        }
                      </div>
                    </div>
                  </div>
                </td>
              } @else if (
                isSlotCoveredBySpanningAppointment(
                  selectedDate(),
                  slot.slotIndex
                )
              ) {
                <!-- Covered by rowspan above -->
              } @else {
                <td
                  class="day-cell p-1 relative"
                  [class.is-today]="isToday(selectedDate())"
                  (click)="onCellClick(selectedDate(), slot)"
                  tabindex="0"
                  role="button"
                >
                  <!-- Current Time Line -->
                  @if (
                    isToday(selectedDate()) && isCurrentSlot(slot.slotIndex)
                  ) {
                    <div
                      class="current-time-line"
                      [style.top.%]="getCurrentSlotMinutePercentage()"
                    ></div>
                  }

                  <div class="flex flex-column md:flex-row gap-1 md:gap-2">
                    @let slotApts =
                      getAppointmentsForDaySlot(selectedDate(), slot.slotIndex);

                    @if (slotApts.length === 1) {
                      @let apt = slotApts[0];
                      <div
                        class="flex-1 apt-card--positioned p-1 md:p-2 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                        [class.border-green-500]="apt.completed"
                        [class.surface-green-50]="apt.completed"
                        [style.top.%]="getAppointmentTopPctInHour(apt)"
                        [style.height.%]="getAppointmentHeightPctInHour(apt)"
                        (click)="onAppointmentClick($event, apt)"
                        tabindex="0"
                        role="button"
                      >
                        <div
                          class="flex justify-content-between align-items-start"
                        >
                          <div class="flex-1">
                            <div class="font-semibold text-xs md:text-sm">
                              {{ apt.client.name }}
                            </div>
                            <div class="text-xs flex align-items-center gap-1">
                              <span>{{ apt.dog.name }}</span>
                              @if (apt.dog.isAggressive) {
                                <i
                                  class="pi pi-exclamation-triangle text-red-600 font-bold mr-1"
                                  pTooltip="LET OP: AGRESSIEF"
                                ></i>
                              }
                            </div>
                            <div class="text-xs mt-1">
                              {{ apt.startTime | date: "HH:mm" }} -
                              {{ apt.endTime | date: "HH:mm" }}
                            </div>
                          </div>
                        </div>
                      </div>
                    } @else {
                      @for (apt of slotApts; track apt.id) {
                        <div
                          class="flex-1 p-1 md:p-2 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                          [class.border-green-500]="apt.completed"
                          [class.surface-green-50]="apt.completed"
                          (click)="onAppointmentClick($event, apt)"
                          tabindex="0"
                          role="button"
                        >
                          <div
                            class="flex justify-content-between align-items-start"
                          >
                            <div class="flex-1">
                              <div class="font-semibold text-xs md:text-sm">
                                {{ apt.client.name }}
                              </div>
                              <div
                                class="text-xs flex align-items-center gap-1"
                              >
                                <span>{{ apt.dog.name }}</span>
                                @if (apt.dog.isAggressive) {
                                  <i
                                    class="pi pi-exclamation-triangle text-red-600 font-bold mr-1"
                                    pTooltip="LET OP: AGRESSIEF"
                                  ></i>
                                }
                              </div>
                              <div class="text-xs mt-1">
                                {{ apt.startTime | date: "HH:mm" }} -
                                {{ apt.endTime | date: "HH:mm" }}
                              </div>
                            </div>
                          </div>
                          <div class="apt-meta text-2xs md:text-xs mt-2">
                            <p-tag
                              severity="info"
                              styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                              [value]="getBreedLabel(apt)"
                            ></p-tag>
                            @let gender = getGenderLabel(apt);
                            @if (gender) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                              >
                                <i [class]="gender.icon" aria-hidden="true"></i>
                                <span>{{ gender.text }}</span>
                              </p-tag>
                            }
                            @let ageLabel = getAgeLabel(apt);
                            @if (ageLabel) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                                [value]="ageLabel"
                              ></p-tag>
                            }
                            @let svcNames = getServiceNames(apt);
                            @if (svcNames) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                                [value]="svcNames"
                              ></p-tag>
                            }
                            @let pkgNames = getPackageNames(apt);
                            @if (pkgNames) {
                              <p-tag
                                severity="secondary"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs"
                                [value]="pkgNames"
                              ></p-tag>
                            }
                            @if (hasNotes(apt)) {
                              <p-tag
                                severity="warn"
                                styleClass="p-tag-rounded px-2 py-1 text-2xs md:text-xs flex align-items-center gap-1"
                              >
                                <i class="pi pi-pencil" aria-hidden="true"></i>
                                <span>Notities</span>
                              </p-tag>
                            }
                          </div>
                        </div>
                      }
                    }
                  </div>
                </td>
              }
            </tr>
          </ng-template>
        </p-table>
      }
      <!-- Month View -->
      @if (viewMode() === "month") {
        <p-table [value]="monthWeeks()">
          <ng-template pTemplate="header">
            <tr>
              @for (dayName of dayNames; track dayName) {
                <th class="text-center p-2 text-sm md:text-base">
                  {{ dayName }}
                </th>
              }
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-week>
            <tr>
              @for (day of week; track day.date.getTime()) {
                <td
                  class="month-cell p-2"
                  [class.is-today]="day.isToday"
                  [class.other-month]="day.isOtherMonth"
                  (click)="onCellClick(day.date)"
                  tabindex="0"
                  role="button"
                >
                  <div
                    class="inline-flex align-items-center justify-content-center border-circle font-semibold text-sm mb-1"
                    [ngClass]="{
                      'w-1rem h-1rem md:w-2rem md:h-2rem': true,
                      'bg-primary text-primary-contrast': day.isToday,
                      'text-color': !day.isToday,
                    }"
                  >
                    {{ day.dayNumber }}
                  </div>
                  <div class="flex flex-column gap-1">
                    @for (apt of day.appointments; track apt.id) {
                      <div
                        class="p-1 border-left-2 border-primary surface-50 border-round cursor-pointer text-xs hover:surface-100 transition-colors transition-duration-150 white-space-nowrap overflow-hidden text-overflow-ellipsis"
                        [class.border-green-500]="apt.completed"
                        [class.surface-green-50]="apt.completed"
                        [pTooltip]="
                          apt.client.name +
                          ' 路 ' +
                          apt.dog.name +
                          ' 路 ' +
                          (apt.startTime | date: 'HH:mm')
                        "
                        (click)="onAppointmentClick($event, apt)"
                        tabindex="0"
                        role="button"
                      >
                        <span class="hidden md:inline">{{
                          apt.startTime | date: "HH:mm"
                        }}</span>
                        <span class="md:hidden">{{
                          apt.startTime | date: "HH"
                        }}</span>
                        <span class="font-semibold">{{ apt.dog.name }}</span>
                        <span class="opacity-80">路 {{ apt.client.name }}</span>
                        @let gender = getGenderLabel(apt);
                        @if (gender) {
                          <i [class]="gender.icon" aria-hidden="true"></i>
                        }
                        @let ageLabel = getAgeLabel(apt);
                        @if (ageLabel) {
                          <span class="opacity-70">路 {{ ageLabel }}</span>
                        }
                        @if (apt.dog.isAggressive) {
                          <i
                            class="pi pi-exclamation-triangle text-red-600"
                            aria-hidden="true"
                          ></i>
                        }
                      </div>
                    }
                  </div>
                </td>
              }
            </tr>
          </ng-template>
        </p-table>
      }
    </div>
  </p-card>
</div>
