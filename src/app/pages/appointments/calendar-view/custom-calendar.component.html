<div
  class="p-0 md:px-4"
  appSwipe
  (swipeLeft)="nextPeriod()"
  (swipeRight)="previousPeriod()"
>
  <p-card>
    <!-- Header -->
    <div
      class="flex flex-column md:flex-row justify-content-between align-items-center gap-1 mb-4"
    >
      <div class="hidden md:flex gap-2 align-items-center">
        <p-button
          icon="pi pi-chevron-left"
          (onClick)="previousPeriod()"
          [rounded]="true"
          [text]="true"
          size="small"
        />
        <p-button
          label="Vandaag"
          (onClick)="goToToday()"
          [text]="true"
          size="small"
        />
        <p-button
          icon="pi pi-chevron-right"
          (onClick)="nextPeriod()"
          [rounded]="true"
          [text]="true"
          size="small"
        />
      </div>

      <h2 class="m-0 text-xl md:text-2xl font-semibold">
        {{ currentPeriodTitle() }}
      </h2>

      <p-selectButton
        [options]="viewModeOptions"
        [(ngModel)]="viewMode"
        optionLabel="label"
        optionValue="value"
        size="small"
      >
        <ng-template let-item>
          <i [class]="item.icon"></i>
        </ng-template>
      </p-selectButton>
    </div>

    <!-- Week View -->
    @if (viewMode() === "week") {
      <p-table
        [value]="timeSlots"
        [scrollable]="true"
        scrollHeight="600px"
        #calendarTable
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="time-col">Tijd</th>
            @for (day of weekDays(); track day.date.getTime()) {
              <th [class.is-today]="day.isToday" class="text-center p-2">
                <div class="text-xs md:text-sm text-color-secondary mb-1">
                  {{ dayNames[$index] }}
                </div>
                <div
                  class="inline-flex align-items-center justify-content-center border-circle text-sm md:text-base font-semibold"
                  [ngClass]="{
                    'w-2rem h-2rem md:w-2rem md:h-2rem': true,
                    'bg-primary text-primary-contrast': day.isToday,
                    'text-color': !day.isToday,
                  }"
                >
                  {{ day.dayNumber }}
                </div>
              </th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-slot>
          <tr [class.current-time]="isCurrentHour(slot.hour)">
            <td class="time-col">{{ slot.label }}</td>
            @for (day of weekDays(); track day.date.getTime()) {
              <td
                class="day-cell p-1"
                [class.is-today]="day.isToday"
                (click)="onCellClick(day.date, slot.hour)"
                tabindex="0"
                role="button"
              >
                @for (
                  apt of getAppointmentsForDayHour(day.date, slot.hour);
                  track apt.id
                ) {
                  <div
                    class="p-2 mb-1 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                    [class.border-green-500]="apt.completed"
                    [class.surface-green-50]="apt.completed"
                    (click)="onAppointmentClick($event, apt)"
                    tabindex="0"
                    role="button"
                    [pTooltip]="apt.client.name + ' - ' + apt.dog.name"
                  >
                    <div class="font-semibold text-sm">
                      {{ apt.client.name }}
                    </div>
                    <div class="text-xs flex align-items-center gap-1">
                      <span>{{ apt.dog.name }}</span>
                      @if (apt.dog.isAggressive) {
                        <i
                          class="pi pi-exclamation-triangle text-orange-500"
                        ></i>
                      }
                    </div>
                    <div class="text-xs mt-1 hidden md:block">
                      {{ apt.startTime | date: "HH:mm" }} -
                      {{ apt.endTime | date: "HH:mm" }}
                    </div>
                  </div>
                }
              </td>
            }
          </tr>
        </ng-template>
      </p-table>
    }

    <!-- Day View -->
    @if (viewMode() === "day") {
      <p-table
        [value]="timeSlots"
        [scrollable]="true"
        scrollHeight="600px"
        #calendarTable
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="time-col">Tijd</th>
            <th class="p-2">
              <div class="flex align-items-center gap-2">
                <span>{{ selectedDate() | date: "EEEE d MMMM" }}</span>
                @if (isToday(selectedDate())) {
                  <p-badge value="Vandaag" severity="success" />
                }
              </div>
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-slot>
          <tr [class.current-time]="isCurrentHour(slot.hour)">
            <td class="time-col">{{ slot.label }}</td>
            <td
              class="day-cell p-1"
              [class.is-today]="isToday(selectedDate())"
              (click)="onCellClick(selectedDate(), slot.hour)"
              tabindex="0"
              role="button"
            >
              <div class="flex flex-column md:flex-row gap-1 md:gap-2">
                @for (
                  apt of getAppointmentsForDayHour(selectedDate(), slot.hour);
                  track apt.id
                ) {
                  <div
                    class="flex-1 p-2 border-left-3 border-primary surface-50 border-round cursor-pointer hover:surface-100 transition-colors transition-duration-150"
                    [class.border-green-500]="apt.completed"
                    [class.surface-green-50]="apt.completed"
                    (click)="onAppointmentClick($event, apt)"
                    tabindex="0"
                    role="button"
                  >
                    <div class="flex justify-content-between align-items-start">
                      <div class="flex-1">
                        <div class="font-semibold text-sm">
                          {{ apt.client.name }}
                        </div>
                        <div class="text-xs flex align-items-center gap-1">
                          <span>{{ apt.dog.name }}</span>
                          @if (apt.dog.isAggressive) {
                            <i
                              class="pi pi-exclamation-triangle text-orange-500"
                            ></i>
                          }
                        </div>
                        <div class="text-xs mt-1">
                          {{ apt.startTime | date: "HH:mm" }} -
                          {{ apt.endTime | date: "HH:mm" }}
                        </div>
                      </div>
                    </div>
                    <div class="hidden md:flex flex-wrap gap-1 mt-2">
                      @for (service of apt.services; track service.id) {
                        <p-tag
                          [value]="service.name"
                          severity="info"
                          styleClass="text-xs"
                        />
                      }
                      @for (pkg of apt.packages; track pkg.id) {
                        <p-tag
                          [value]="pkg.name"
                          severity="success"
                          styleClass="text-xs"
                        />
                      }
                    </div>
                  </div>
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    }
    <!-- Month View -->
    @if (viewMode() === "month") {
      <p-table [value]="monthWeeks()">
        <ng-template pTemplate="header">
          <tr>
            @for (dayName of dayNames; track dayName) {
              <th class="text-center p-2 text-sm md:text-base">
                {{ dayName }}
              </th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-week>
          <tr>
            @for (day of week; track day.date.getTime()) {
              <td
                class="month-cell p-2"
                [class.is-today]="day.isToday"
                [class.other-month]="day.isOtherMonth"
                (click)="onCellClick(day.date)"
                tabindex="0"
                role="button"
              >
                <div
                  class="inline-flex align-items-center justify-content-center border-circle font-semibold text-sm mb-1"
                  [ngClass]="{
                    'w-1rem h-1rem md:w-2rem md:h-2rem': true,
                    'bg-primary text-primary-contrast': day.isToday,
                    'text-color': !day.isToday,
                  }"
                >
                  {{ day.dayNumber }}
                </div>
                <div class="flex flex-column gap-1">
                  @for (apt of day.appointments; track apt.id) {
                    <div
                      class="p-1 border-left-2 border-primary surface-50 border-round cursor-pointer text-xs hover:surface-100 transition-colors transition-duration-150 white-space-nowrap overflow-hidden text-overflow-ellipsis"
                      [class.border-green-500]="apt.completed"
                      [class.surface-green-50]="apt.completed"
                      [pTooltip]="
                        apt.client.name +
                        ' - ' +
                        apt.dog.name +
                        ' (' +
                        (apt.startTime | date: 'HH:mm') +
                        ')'
                      "
                      (click)="onAppointmentClick($event, apt)"
                      tabindex="0"
                      role="button"
                    >
                      {{ apt.startTime | date: "HH:mm" }} {{ apt.client.name }}
                    </div>
                  }
                </div>
              </td>
            }
          </tr>
        </ng-template>
      </p-table>
    }
  </p-card>
</div>
