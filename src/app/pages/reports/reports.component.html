<div class="md:p-4">
  <p-card styleClass="responsive-card reports-shell">
    <ng-template pTemplate="header">
      <div class="px-3 md:px-4 py-3 sticky top-0 z-5 bg-white shadow-1">
        <h2 class="text-xl md:text-2xl font-bold mb-2 md:mb-3">
          Rapportages & Analytics
        </h2>
        <div
          class="flex flex-column md:flex-row gap-3 justify-content-center align-items-start md:align-items-center"
        >
          <!-- Period Selection -->
          <div class="flex gap-2 flex-wrap w-full md:w-auto">
            <p-selectButton
              [options]="periodOptions"
              [(ngModel)]="selectedPeriod"
              (onChange)="setQuickPeriod($event.value)"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full md:w-auto"
            ></p-selectButton>
          </div>

          <!-- Custom Date Range -->
          <div class="flex gap-2 align-items-center flex-wrap w-full md:w-auto">
            <p-datepicker
              [(ngModel)]="rangeDates"
              (onSelect)="onDateChange()"
              selectionMode="range"
              [readonlyInput]="true"
              dateFormat="dd-mm-yy"
              placeholder="Periode"
              [showIcon]="true"
              styleClass="w-full md:w-auto"
              [inputStyle]="{ width: '250px' }"
              [showClear]="true"
            ></p-datepicker>
          </div>

          <!-- Export Buttons -->
          <div
            class="flex gap-2 ml-auto flex-wrap w-full md:w-auto justify-content-start md:justify-content-end"
          >
            <p-button
              label="PDF"
              icon="pi pi-file-pdf"
              (onClick)="exportToPDF()"
              styleClass="p-button-sm p-button-outlined w-full md:w-auto"
            ></p-button>
            <p-button
              label="Excel"
              icon="pi pi-file-excel"
              (onClick)="exportToExcel()"
              styleClass="p-button-sm p-button-outlined p-button-success w-full md:w-auto"
            ></p-button>
          </div>
        </div>
      </div>
    </ng-template>

    <!-- Dashboard Content -->
    <div class="grid">
      <!-- Revenue Summary Cards -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Totale Omzet</div>
            <div class="text-3xl font-bold text-primary">
              {{ formatCurrency(revenueReport?.totalRevenue || 0) }}
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Aantal Afspraken</div>
            <div class="text-3xl font-bold text-primary">
              {{ revenueReport?.appointmentCount || 0 }}
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Gemiddelde Omzet</div>
            <div class="text-3xl font-bold text-primary">
              {{
                formatCurrency(revenueReport?.averageRevenuePerAppointment || 0)
              }}
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Bezettingsgraad</div>
            <div class="text-3xl font-bold text-primary">
              {{ formatPercentage(occupancy?.occupancyRate || 0) }}
            </div>
          </div>
        </p-card>
      </div>

      <!-- Profit/Loss Summary Cards -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Totale Uitgaven</div>
            <div class="text-3xl font-bold text-red-500">
              {{ formatCurrency(expenseReport?.totalExpenses || 0) }}
            </div>
            <small class="text-500"
              >{{ expenseReport?.expenseCount || 0 }} uitgaven</small
            >
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Netto Winst</div>
            <div
              class="text-3xl font-bold"
              [class.text-green-600]="(profitLossReport?.netProfit || 0) >= 0"
              [class.text-red-500]="(profitLossReport?.netProfit || 0) < 0"
            >
              {{ formatCurrency(profitLossReport?.netProfit || 0) }}
            </div>
            <small
              [class.text-green-600]="profitLossReport?.breakEven"
              [class.text-red-500]="!profitLossReport?.breakEven"
            >
              @if (profitLossReport?.breakEven) {
                <i class="pi pi-check-circle"></i> Break-even bereikt
              } @else {
                <i class="pi pi-times-circle"></i> In de min
              }
            </small>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Winstmarge</div>
            <div
              class="text-3xl font-bold"
              [class.text-green-600]="
                (profitLossReport?.profitMargin || 0) >= 0
              "
              [class.text-red-500]="(profitLossReport?.profitMargin || 0) < 0"
            >
              {{ formatPercentage(profitLossReport?.profitMargin || 0) }}
            </div>
            <small class="text-500">
              @if ((profitLossReport?.profitMargin || 0) >= 30) {
                Uitstekend
              } @else if ((profitLossReport?.profitMargin || 0) >= 15) {
                Goed
              } @else if ((profitLossReport?.profitMargin || 0) >= 0) {
                Matig
              } @else {
                Verliesgevend
              }
            </small>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="reports-kpi-card">
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Effectief Uurloon</div>
            <div
              class="text-3xl font-bold"
              [class.text-green-600]="
                hourlyRateKPI?.status === 'EXCEEDING' ||
                hourlyRateKPI?.status === 'TARGET'
              "
              [class.text-orange-600]="hourlyRateKPI?.status === 'APPROACHING'"
              [class.text-red-500]="
                hourlyRateKPI?.status === 'BELOW' || !hourlyRateKPI
              "
            >
              {{ formatCurrency(hourlyRateKPI?.actualHourlyRate || 0) }}/uur
            </div>
            <small class="text-500">
              @if (hourlyRateKPI?.status === "EXCEEDING") {
                <i class="pi pi-star-fill text-green-600"></i> Boven target! ({{
                  hourlyRateKPI?.percentageOfTarget?.toFixed(0)
                }}%)
              } @else if (hourlyRateKPI?.status === "TARGET") {
                <i class="pi pi-check-circle text-green-600"></i> Target bereikt
                (‚Ç¨60)
              } @else if (hourlyRateKPI?.status === "APPROACHING") {
                <i class="pi pi-arrow-up text-orange-600"></i>
                {{ hourlyRateKPI?.percentageOfTarget?.toFixed(0) }}% van ‚Ç¨60
                target
              } @else if (
                hourlyRateKPI?.totalHoursWorked &&
                hourlyRateKPI.totalHoursWorked > 0
              ) {
                <i class="pi pi-arrow-right text-red-500"></i>
                {{ hourlyRateKPI?.percentageOfTarget?.toFixed(0) }}% van ‚Ç¨60
                target
              } @else {
                Geen tijddata beschikbaar
              }
            </small>
            @if (
              hourlyRateKPI?.totalHoursWorked &&
              hourlyRateKPI.totalHoursWorked > 0
            ) {
              <div class="mt-2 text-xs text-500">
                {{ hourlyRateKPI.totalHoursWorked.toFixed(1) }} uur gewerkt
              </div>
            }
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card>
          <div class="text-center">
            <div class="text-500 font-semibold mb-2">Break-Even Punt</div>
            <div class="text-3xl font-bold text-primary">
              {{ formatCurrency(expenseReport?.totalExpenses || 0) }}
            </div>
            <small class="text-500">
              @if (profitLossReport?.breakEven) {
                Minimaal benodigde omzet bereikt
              } @else {
                @if ((profitLossReport?.totalRevenue || 0) > 0) {
                  Nog
                  {{
                    formatCurrency(
                      (expenseReport?.totalExpenses || 0) -
                        (profitLossReport?.totalRevenue || 0)
                    )
                  }}
                  nodig
                } @else {
                  Nog geen omzet
                }
              }
            </small>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Charts and Tables Row -->
    <div class="grid mt-3">
      <!-- Top Clients -->
      <div class="col-12 lg:col-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-3">
              <h3 class="text-xl font-semibold">Top Klanten</h3>
            </div>
          </ng-template>
          <p-table [value]="topClients || []" [rows]="5">
            <ng-template pTemplate="header">
              <tr>
                <th>Klant</th>
                <th>Afspraken</th>
                <th>Omzet</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-client>
              <tr>
                <td>{{ client.clientName }}</td>
                <td>{{ client.appointmentCount }}</td>
                <td>{{ formatCurrency(client.totalRevenue) }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3" class="text-center">
                  Geen gegevens beschikbaar
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <!-- Popular Services -->
      <div class="col-12 lg:col-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-3">
              <h3 class="text-xl font-semibold">Populairste Werkzaamheden</h3>
            </div>
          </ng-template>
          <p-table [value]="popularServices || []" [rows]="5">
            <ng-template pTemplate="header">
              <tr>
                <th>Werkzaamheid</th>
                <th>Gebruik</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-service>
              <tr>
                <td>{{ service.serviceName }}</td>
                <td>{{ service.usageCount }}x</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="2" class="text-center">
                  Geen gegevens beschikbaar
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <!-- Popular Packages -->
      <div class="col-12 lg:col-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-3">
              <h3 class="text-xl font-semibold">Populairste Pakketten</h3>
            </div>
          </ng-template>
          <p-table [value]="popularPackages || []" [rows]="5">
            <ng-template pTemplate="header">
              <tr>
                <th>Pakket</th>
                <th>Gebruik</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-package>
              <tr>
                <td>{{ package.packageName }}</td>
                <td>{{ package.usageCount }}x</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="2" class="text-center">
                  Geen gegevens beschikbaar
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <!-- Occupancy Details -->
      <div class="col-12 lg:col-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-3">
              <h3 class="text-xl font-semibold">Bezettingsgraad</h3>
            </div>
          </ng-template>
          <div class="p-3">
            <div class="flex justify-content-between mb-2">
              <span>Beschikbare uren:</span>
              <span class="font-semibold">{{
                occupancy?.totalAvailableHours?.toFixed(1) || 0
              }}</span>
            </div>
            <div class="flex justify-content-between mb-2">
              <span>Geboekte uren:</span>
              <span class="font-semibold">{{
                occupancy?.totalBookedHours?.toFixed(1) || 0
              }}</span>
            </div>
            <div class="flex justify-content-between mb-2">
              <span>Bezettingsgraad:</span>
              <span class="font-semibold text-primary">{{
                formatPercentage(occupancy?.occupancyRate || 0)
              }}</span>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Financial Section -->
    <div class="grid mt-3">
      <!-- Breed Performance -->
      <div class="col-12">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-3">
              <h3 class="text-xl font-semibold">üêï Uurloon per Ras</h3>
            </div>
          </ng-template>
          @if (breedPerformance && breedPerformance.length > 0) {
            <p-table [value]="breedPerformance" [rows]="10">
              <ng-template pTemplate="header">
                <tr>
                  <th>Ras</th>
                  <th>Afspraken</th>
                  <th>Gem. tijd</th>
                  <th>‚Ç¨/uur</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-breed>
                <tr>
                  <td>{{ breed.breedName }}</td>
                  <td>{{ breed.appointmentCount }}</td>
                  <td>{{ breed.averageMinutesWorked.toFixed(0) }} min</td>
                  <td>
                    <span
                      class="font-semibold"
                      [class.text-green-600]="breed.effectiveHourlyRate >= 60"
                      [class.text-orange-600]="
                        breed.effectiveHourlyRate >= 50 &&
                        breed.effectiveHourlyRate < 60
                      "
                      [class.text-red-500]="breed.effectiveHourlyRate < 50"
                    >
                      {{ formatCurrency(breed.effectiveHourlyRate) }}
                    </span>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          } @else {
            <div class="p-3 text-center text-500">
              <i class="pi pi-chart-bar" style="font-size: 2rem"></i>
              <p class="mt-2">Geen prestatie data per ras beschikbaar.</p>
              <p class="text-sm">
                Log afspraken met rassen om inzicht te krijgen.
              </p>
            </div>
          }
        </p-card>
      </div>

      <div class="col-12">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-3">
              <h3 class="text-xl font-semibold">Financieel Overzicht</h3>
            </div>
          </ng-template>
          <div class="p-3">
            <p class="text-500">
              Facturen en betalingen worden hier weergegeven wanneer deze
              beschikbaar zijn.
            </p>
            <p class="text-500 mt-2">
              <i class="pi pi-info-circle mr-2"></i>
              Tip: Koppel afspraken aan facturen om financi√´le rapportages te
              genereren.
            </p>
          </div>
        </p-card>
      </div>
    </div>
  </p-card>
</div>
