<div class="md:p-4">
  <p-card styleClass="responsive-card mx-auto max-w-4xl">
    <ng-template pTemplate="title">
      <h2 class="m-0 mb-5">
        {{ isEditMode ? "Werkzaamheid Bewerken" : "Nieuwe Werkzaamheid" }}
      </h2>
    </ng-template>
    <form [formGroup]="form" class="p-fluid form-content-wrapper">
      <!-- Basic Info -->
      <div class="field">
        <p-floatlabel variant="on">
          <input
            pInputText
            id="name"
            [formControl]="name"
            class="w-full"
            autocomplete="off"
          />
          <label for="name">Naam</label>
        </p-floatlabel>
      </div>
      <div class="field">
        <p-floatlabel variant="on">
          <textarea
            pInputTextarea
            id="description"
            [formControl]="description"
            rows="3"
            class="w-full"
          ></textarea>
          <label for="description">Omschrijving</label>
        </p-floatlabel>
      </div>

      <!-- Size-based Pricing -->
      <div class="mt-4">
        <h4 class="mb-3">Prijzen per Hondengrootte</h4>
        <div class="formgrid grid">
          <!-- Small -->
          <div class="field col-12 md:col-4">
            <label for="pricingSmall" class="font-semibold">Klein</label>
            <p-inputNumber
              id="pricingSmall"
              formControlName="pricingSmall"
              mode="currency"
              currency="EUR"
              styleClass="w-full"
            ></p-inputNumber>
            <p-inputNumber
              id="durationSmall"
              formControlName="durationSmall"
              suffix=" min"
              styleClass="w-full mt-2"
              placeholder="Duur (minuten)"
            ></p-inputNumber>
            @if (
              form.get("pricingSmall")?.value &&
              form.get("durationSmall")?.value
            ) {
              @let rate = calculateHourlyRateForSize("small");
              <small
                [class]="
                  rate.meetsTarget ? 'text-green-600' : 'text-orange-600'
                "
              >
                {{ rate.effectiveRate | currency: "EUR" }}/uur ({{
                  rate.percentageOfTarget | number: "1.0-0"
                }}% van €{{ targetHourlyRate }})
              </small>
            }
          </div>

          <!-- Medium -->
          <div class="field col-12 md:col-4">
            <label for="pricingMedium" class="font-semibold">Middel</label>
            <p-inputNumber
              id="pricingMedium"
              formControlName="pricingMedium"
              mode="currency"
              currency="EUR"
              styleClass="w-full"
            ></p-inputNumber>
            <p-inputNumber
              id="durationMedium"
              formControlName="durationMedium"
              suffix=" min"
              styleClass="w-full mt-2"
              placeholder="Duur (minuten)"
            ></p-inputNumber>
            @if (
              form.get("pricingMedium")?.value &&
              form.get("durationMedium")?.value
            ) {
              @let rate = calculateHourlyRateForSize("medium");
              <small
                [class]="
                  rate.meetsTarget ? 'text-green-600' : 'text-orange-600'
                "
              >
                {{ rate.effectiveRate | currency: "EUR" }}/uur ({{
                  rate.percentageOfTarget | number: "1.0-0"
                }}% van €{{ targetHourlyRate }})
              </small>
            }
          </div>

          <!-- Large -->
          <div class="field col-12 md:col-4">
            <label for="pricingLarge" class="font-semibold">Groot</label>
            <p-inputNumber
              id="pricingLarge"
              formControlName="pricingLarge"
              mode="currency"
              currency="EUR"
              styleClass="w-full"
            ></p-inputNumber>
            <p-inputNumber
              id="durationLarge"
              formControlName="durationLarge"
              suffix=" min"
              styleClass="w-full mt-2"
              placeholder="Duur (minuten)"
            ></p-inputNumber>
            @if (
              form.get("pricingLarge")?.value &&
              form.get("durationLarge")?.value
            ) {
              @let rate = calculateHourlyRateForSize("large");
              <small
                [class]="
                  rate.meetsTarget ? 'text-green-600' : 'text-orange-600'
                "
              >
                {{ rate.effectiveRate | currency: "EUR" }}/uur ({{
                  rate.percentageOfTarget | number: "1.0-0"
                }}% van €{{ targetHourlyRate }})
              </small>
            }
          </div>
        </div>
      </div>

      <!-- Breed Overrides -->
      <div class="mt-4" formArrayName="breedOverrides">
        <div class="flex justify-content-between align-items-center mb-2">
          <h4 class="m-0">Ras-specifieke Aanpassingen</h4>
          <p-button
            icon="pi pi-plus"
            label="Ras Toevoegen"
            (click)="addBreedOverride()"
            type="button"
            size="small"
          ></p-button>
        </div>
        <p-table
          [value]="breedOverridesArray.controls"
          styleClass="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Ras</th>
              <th>Prijsaanpassing</th>
              <th>Tijdsaanpassing</th>
              <th>Reden</th>
              <th style="width: 5rem"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-overrideGroup let-i="rowIndex">
            <tr [formGroupName]="i">
              <td>
                <p-select
                  [options]="allBreeds"
                  optionLabel="name"
                  placeholder="Selecteer Ras"
                  styleClass="w-full"
                  appendTo="body"
                  (onChange)="onBreedSelect(i, $event.value)"
                ></p-select>
              </td>
              <td>
                <p-inputNumber
                  formControlName="priceAdjustment"
                  mode="currency"
                  currency="EUR"
                  styleClass="w-full"
                  placeholder="+/- prijs"
                ></p-inputNumber>
              </td>
              <td>
                <p-inputNumber
                  formControlName="durationAdjustment"
                  suffix=" min"
                  styleClass="w-full"
                  placeholder="+/- tijd"
                ></p-inputNumber>
              </td>
              <td>
                <input
                  pInputText
                  formControlName="reason"
                  placeholder="Bv: dikke vacht, moeilijk gedrag"
                  class="w-full"
                />
              </td>
              <td>
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-danger"
                  (click)="removeBreedOverride(i)"
                  type="button"
                  size="small"
                ></p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center text-color-secondary">
                Geen ras-specifieke aanpassingen. Klik op "Ras Toevoegen" voor
                moeilijke rassen zoals Poedels.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </form>
    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2 sticky-footer-actions">
        <p-button
          label="Annuleren"
          icon="pi pi-times"
          styleClass="p-button-text"
          (click)="cancel()"
          type="button"
        ></p-button>
        <p-button
          label="Opslaan"
          icon="pi pi-check"
          (click)="save()"
          [disabled]="form.invalid"
        ></p-button>
      </div>
    </ng-template>
  </p-card>
</div>
